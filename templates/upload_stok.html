<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Update Stok Harian</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="icon" href="{{ url_for('static', filename='logo_desktop.svg') }}" type="image/svg+xml">
</head>

<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col font-sans">

    <!-- ===== Header ===== -->
    {% include "components/header.html" %}

    <!-- ===== Konten Utama ===== -->
    <main class="flex-grow flex items-center justify-center py-12 px-4">
        <div class="w-full max-w-5xl mx-auto p-8 flex flex-col items-center text-center">

            <h1 class="text-3xl font-bold text-gray-900 mb-2">Update Stok Harian</h1>
            <p class="mt-2 mb-8 text-gray-600">Pilih salah satu cara di bawah untuk memulai proses update stok.</p>

            <!-- Form Utama -->
            <form id="upload-form" action="{{ url_for('upload.update_stok') }}" method="post" enctype="multipart/form-data" class="w-full flex flex-col items-center gap-10">

                <!-- Flex Container for Two Options -->
                <div class="flex flex-col md:flex-row gap-8 w-full">

                    <!-- LEFT BLOCK: UPLOAD & SEND TO CDN -->
                    <div id="upload-block" class="flex-1 bg-white p-8 rounded-xl shadow-lg border border-gray-200 flex flex-col">
                        <h2 class="text-xl font-semibold mb-6 text-gray-800 text-left flex items-center gap-3">
                            <span>Upload File Baru & Kirim ke R2</span> </h2>

                        <label for="file-input" class="cursor-pointer bg-gray-100 border border-gray-300 text-gray-700 font-medium py-3 px-6 rounded-lg shadow-sm hover:bg-gray-200 transition-colors inline-block w-full text-center mb-4">
                            Pilih File CSV Penjualan
                        </label>
                        <input type="file" name="file" id="file-input" accept=".csv" class="hidden" onchange="document.getElementById('upload-form').submit();" />

                        <div class="mb-6 p-4 rounded-lg border border-dashed {% if selected_file %}border-green-400 bg-green-50 text-green-800{% else %}border-gray-300 bg-gray-50 text-gray-600{% endif %}">
                            {% if selected_file %}
                                <p class="text-sm font-medium flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                    File <strong>{{ selected_file }}</strong> siap. Pilih tanggal lalu upload ke R2. </p>
                            {% else %}
                                <p class="text-sm">Belum ada file dipilih. Preview akan muncul di bawah setelah upload.</p>
                            {% endif %}
                        </div>

                        <div class="flex-grow"></div>

                        <div class="mt-auto">
                            <label for="r2-date-picker" class="block text-sm font-medium text-gray-700 mb-2 text-left">Tanggal Penamaan File di R2:</label>
                            <input type="date" id="r2-date-picker" min="2025-04-01" max="2025-04-15" class="block w-full px-4 py-3 mb-1 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 sm:text-sm">
                            <p id="r2-date-message" class="text-xs text-red-600 text-left mb-4 hidden">Pilih tanggal untuk mengaktifkan tombol upload!</p>

                            <button type="button"
                                    id="upload-r2-btn"
                                    class="cursor-pointer bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors w-full disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-green-300 hover:bg-green-700"
                                    disabled
                                    data-file-to-upload="{{ selected_file or '' }}">
                                Upload {{ selected_file or 'File' }} ke CDN </button>
                        </div>
                    </div>


                    <!-- RIGHT BLOCK: START WORKFLOW (Assuming file already in CDN) -->
                    <div id="workflow-block" class="flex-1 bg-white p-8 rounded-xl shadow-lg border border-gray-200 flex flex-col">
                        <h2 class="text-xl font-semibold mb-6 text-gray-800 text-left flex items-center gap-3">
                             <span>Mulai Update Stok dari CDN</span>
                        </h2>
                        <p class="text-sm text-gray-600 mb-6 text-left">Gunakan opsi ini jika file CSV penjualan harian sudah ada di CDN (Google Drive).</p>

                         <!-- Spacer to push button down -->
                        <div class="flex-grow"></div>

                        <!-- Date Picker & Start Button Container -->
                         <div class="mt-auto">
                            <label for="workflow-date-picker" class="block text-sm font-medium text-gray-700 mb-2 text-left">Pilih Tanggal File di CDN:</label>
                            <input type="date" id="workflow-date-picker" name="selected_date_workflow"
                                min="2025-04-01" max="2025-04-15"
                                class="block w-full px-4 py-3 mb-1 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                             <p id="workflow-date-message" class="text-xs text-red-600 text-left mb-4 hidden">Pilih tanggal untuk memulai update!</p>

                            <button type="button"
                                    id="start-update-btn"
                                    class="bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition-colors w-full disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-blue-300 hover:bg-blue-700"
                                    disabled>
                                Mulai Update Stok
                            </button>
                        </div>
                    </div>

                </div>

                <!-- Preview Box -->
                {% if json_data %}
                <div id="preview-box" class="w-full mt-10 bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 text-left">Preview Data File (Max 20 Baris)</h3>
                    <div class="overflow-auto max-h-80 border border-gray-200 rounded-lg">
                        <pre class="text-xs whitespace-pre-wrap w-full bg-gray-50 p-4 text-gray-700 text-left">{{ json_data }}</pre>
                    </div>
                </div>
                {% endif %}

                <!-- Hidden Input for Server Filename -->
                <input type="hidden" name="server_filename" value="{{ selected_file or '' }}" />

            </form>
        </div>
    </main>


    <!-- ===== Footer Status Bar (Fixed) ===== -->
    {% include "components/footer.html" %}

    <!-- ============================================= -->
    <!-- Logika Javascript            -->
    <!-- ============================================= -->
    <script>
        // Pass the selected file from Flask to JavaScript
        const selectedFileFromServer = "{{ selected_file or '' }}";
    </script>
    <script src="{{ url_for('static', filename='javascript/upload_stok.js') }}"></script>

</body>
</html>