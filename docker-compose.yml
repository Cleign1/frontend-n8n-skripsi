services:
  # Service 2: The Flask Web Application (served with Gunicorn)
  app:
    build: . # Build the image from the Dockerfile in the current directory
    container_name: fe-n8n-app
    ports:
      - "5000:5000" # Maps container port 5000 to host port 5000
    command: gunicorn --workers=4 --bind 0.0.0.0:5000 --log-level info "run:app"
    volumes:
      - .:/app # Mounts the project directory for live code changes
    restart: always
    env_file: .env
    environment:
      - TZ=Asia/Jakarta
    networks:
      - fe-n8n-network

  # Service 3: The Celery Worker
  worker:
    build: . # Also builds from the same Dockerfile
    container_name: fe-n8n-worker
    # This command overrides the Dockerfile's CMD to start the celery worker
    command: celery -A make_celery.celery worker --loglevel=info --pool=solo -n worker1@%h
    volumes:
      - .:/app # Mounts the project directory for live code changes
    restart: always
    env_file: .env
    environment:
      # The worker communicates with the 'app' service over the internal Docker network
      - INTERNAL_API_BASE_URL=http://app:5000
      - TZ=Asia/Jakarta
    networks:
      - fe-n8n-network

networks:
  fe-n8n-network:
    driver: bridge  
